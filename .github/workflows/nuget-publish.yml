name: ğŸ“¦ NuGet Package Build & Publish

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Directory.Build.props'
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish to NuGet.org'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '10.0.x'
  BUILD_CONFIGURATION: 'Release'

jobs:
  # Version ì¶”ì¶œ ë° ë³€ê²½ ê°ì§€
  detect-version:
    name: ğŸ” Detect Version Changes
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ“Š Extract Version from Directory.Build.props
        id: extract-version
        run: |
          VERSION=$(grep -oP '(?<=<VersionPrefix>)[^<]*' Directory.Build.props)
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: â„¹ï¸ Version Info
        run: |
          echo "Detected version: ${{ steps.extract-version.outputs.version }}"
          echo "This workflow will proceed to build and publish the NuGet package."

  # NuGet íŒ¨í‚¤ì§€ ë¹Œë“œ (FileFlux SDK)
  build-sdk:
    name: ğŸ“¦ Build FileFlux SDK
    runs-on: ubuntu-latest
    needs: detect-version
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Create FileFlux NuGet Package
        run: |
          dotnet pack src/FileFlux/FileFlux.csproj \
            --configuration Release \
            --output nupkg/ \
            -p:PackageVersion=${{ needs.detect-version.outputs.version }} \
            -p:AssemblyVersion=${{ needs.detect-version.outputs.version }} \
            -p:FileVersion=${{ needs.detect-version.outputs.version }}

      - name: ğŸ“‹ List Generated Packages
        run: ls -la nupkg/

      - name: ğŸ“¤ Upload SDK Package
        uses: actions/upload-artifact@v4
        with:
          name: fileflux-sdk
          path: nupkg/FileFlux.*.nupkg

      - name: ğŸ“¤ Upload SDK Symbols
        uses: actions/upload-artifact@v4
        with:
          name: fileflux-sdk-symbols
          path: nupkg/FileFlux.*.snupkg

  # dotnet tool ë¹Œë“œ (FileFlux.CLI)
  build-cli:
    name: ğŸ”§ Build FileFlux CLI Tool
    runs-on: ubuntu-latest
    needs: detect-version
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ”§ Create FileFlux.CLI Tool Package
        run: |
          dotnet pack src/FileFlux.CLI/FileFlux.CLI.csproj \
            --configuration Release \
            --output nupkg/ \
            -p:PackageVersion=${{ needs.detect-version.outputs.version }} \
            -p:AssemblyVersion=${{ needs.detect-version.outputs.version }} \
            -p:FileVersion=${{ needs.detect-version.outputs.version }}

      - name: ğŸ“‹ List Generated Packages
        run: ls -la nupkg/

      - name: ğŸ“¤ Upload CLI Package
        uses: actions/upload-artifact@v4
        with:
          name: fileflux-cli
          path: nupkg/FileFlux.CLI.*.nupkg

      - name: ğŸ“¤ Upload CLI Symbols
        uses: actions/upload-artifact@v4
        with:
          name: fileflux-cli-symbols
          path: nupkg/FileFlux.CLI.*.snupkg

  # NuGet.orgì— ê²Œì‹œ
  publish-nuget:
    name: ğŸš€ Publish to NuGet.org
    runs-on: ubuntu-latest
    needs: [detect-version, build-sdk, build-cli]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Download SDK Package
        uses: actions/download-artifact@v4
        with:
          name: fileflux-sdk
          path: nupkg/

      - name: ğŸ“¦ Download SDK Symbols
        uses: actions/download-artifact@v4
        with:
          name: fileflux-sdk-symbols
          path: nupkg/

      - name: ğŸ”§ Download CLI Package
        uses: actions/download-artifact@v4
        with:
          name: fileflux-cli
          path: nupkg/

      - name: ğŸ”§ Download CLI Symbols
        uses: actions/download-artifact@v4
        with:
          name: fileflux-cli-symbols
          path: nupkg/

      - name: ğŸ“‹ Verify Downloaded Packages
        run: ls -la nupkg/

      - name: ğŸš€ Publish FileFlux SDK to NuGet.org
        run: |
          for package in nupkg/FileFlux.[0-9]*.nupkg; do
            echo "Publishing SDK: $package..."
            dotnet nuget push "$package" \
              --api-key ${{ secrets.NUGET_API_KEY }} \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate \
              --no-symbols
          done
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

      - name: ğŸ”§ Publish FileFlux.CLI Tool to NuGet.org
        run: |
          for package in nupkg/FileFlux.CLI.*.nupkg; do
            echo "Publishing CLI tool: $package..."
            dotnet nuget push "$package" \
              --api-key ${{ secrets.NUGET_API_KEY }} \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate \
              --no-symbols
          done
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

      - name: ğŸ·ï¸ Create Git Tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag "v${{ needs.detect-version.outputs.version }}"
          git push origin "v${{ needs.detect-version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
  create-release:
    name: ğŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [detect-version, publish-nuget]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download SDK Package
        uses: actions/download-artifact@v4
        with:
          name: fileflux-sdk
          path: nupkg/

      - name: ğŸ”§ Download CLI Package
        uses: actions/download-artifact@v4
        with:
          name: fileflux-cli
          path: nupkg/

      - name: ğŸ“ Generate Release Notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          ## ğŸš€ FileFlux v${{ needs.detect-version.outputs.version }}

          ### ğŸ“¦ FileFlux SDK (NuGet Package)
          ```bash
          dotnet add package FileFlux --version ${{ needs.detect-version.outputs.version }}
          ```

          ### ğŸ”§ FileFlux CLI (dotnet tool)
          ```bash
          dotnet tool install --global FileFlux.CLI --version ${{ needs.detect-version.outputs.version }}
          ```

          ### ğŸ”— Links
          - [FileFlux SDK on NuGet](https://www.nuget.org/packages/FileFlux/${{ needs.detect-version.outputs.version }})
          - [FileFlux CLI on NuGet](https://www.nuget.org/packages/FileFlux.CLI/${{ needs.detect-version.outputs.version }})
          - [Documentation](https://github.com/iyulab/FileFlux#readme)

          ### ğŸ“Š Benchmarks
          All document formats achieve **A+ performance grade** with excellent memory efficiency.

          ### ğŸ› ï¸ What's Included

          **FileFlux SDK:**
          - Complete RAG-optimized document processing SDK
          - Support for PDF, DOCX, Excel, PowerPoint, Markdown and more
          - Intelligent chunking strategies with semantic boundary detection
          - Advanced metadata extraction and performance optimization

          **FileFlux CLI:**
          - Command-line interface for document processing
          - AI-powered metadata enrichment (OpenAI, Anthropic)
          - Multiple output formats (JSON, JSONL, Markdown)
          - Commands: info, extract, chunk, process

          ---

          ğŸ¤– *This release was automatically generated and published by GitHub Actions*
          EOF

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect-version.outputs.version }}
          name: FileFlux v${{ needs.detect-version.outputs.version }}
          body_path: release-notes.md
          files: nupkg/*.nupkg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ì•Œë¦¼
  notify-completion:
    name: ğŸ“¢ Notify Completion
    runs-on: ubuntu-latest
    needs: [detect-version, create-release]
    if: always()
    steps:
      - name: ğŸ‰ Success Notification
        if: needs.create-release.result == 'success'
        run: |
          echo "ğŸ‰ Successfully published FileFlux v${{ needs.detect-version.outputs.version }} to NuGet.org!"
          echo "ğŸ“¦ SDK: https://www.nuget.org/packages/FileFlux/${{ needs.detect-version.outputs.version }}"
          echo "ğŸ”§ CLI: https://www.nuget.org/packages/FileFlux.CLI/${{ needs.detect-version.outputs.version }}"

      - name: âŒ Failure Notification
        if: needs.create-release.result != 'success'
        run: |
          echo "âŒ Failed to publish FileFlux v${{ needs.detect-version.outputs.version }}"
          exit 1